{{- $node := .node -}}
{{- $current := .current -}}

{{- $items := slice -}}

{{- range $page := $node.Pages -}}
  {{- $items = $items | append $page -}}
{{- end -}}

{{- range $item := sort $items "Weight" -}}
  {{- if $item.IsSection -}}
    {{- $child := $item -}}

    <li>
      {{- if or ($child.Sections) ($child.Pages) -}}
        {{- $isCurrentSection := eq $child.RelPermalink $current.RelPermalink -}}
        {{- $hasCurrentPage := or $isCurrentSection (hasPrefix $current.RelPermalink $child.RelPermalink) -}}
        {{- $isActive := eq $child.RelPermalink $current.RelPermalink -}}

        <details class="sidebar__section"{{ if $hasCurrentPage }} open{{ end }}>
          <summary class="sidebar__section--header{{ if $isActive }} is-active{{ end }}">
            <a href="{{ $child.Permalink }}">
              {{- $child.LinkTitle | default $child.Title -}}
            </a>
          </summary>

          <ul class="sidebar__section--pages">
            {{- partial "sidebar-tree.html" (dict "node" $child "current" $current) -}}
          </ul>
        </details>
      {{- else -}}
        <a class="sidebar__section--header" href="{{ $child.Permalink }}">
          {{- $child.LinkTitle | default $child.Title -}}
        </a>
      {{- end -}}
    </li>
  {{- else -}}
    {{- $page := $item -}}
    {{- $isActive := eq $page.RelPermalink $current.RelPermalink -}}

    <li>
      <a
        class="sidebar__link{{ if $isActive }} is-active{{ end }}"
        href="{{ $page.Permalink }}"
      >
        {{- $page.LinkTitle | default $page.Title -}}
      </a>
    </li>
  {{- end -}}
{{- end -}}
